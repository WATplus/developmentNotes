# å®é™…è®°å½•--ç”¨æˆ·æ³¨å†Œ

[toc]



## 1. ç”¨æˆ·æ¨¡å—å‡†å¤‡

- åˆ›å»º user ç›®å½•å­˜æ”¾æ‰€æœ‰å…³äºç”¨æˆ·çš„ç¨‹åº

- åˆ›å»º `user.model.ts` å®šä¹‰ user æ•°æ®çš„ç±»

```js
/*
user/user.model.ts
*/
export class UserModel {
    id? : number;
    name? : string;
    password? : string;
}
```

- åˆ›å»º`user.service.ts` å­˜æ”¾æœåŠ¡ä»£ç  
  
  - å¯¼å…¥ UserModel å’Œ mysql é“¾æ¥ `connection` 

```js
/*
user/user.service.ts
*/
import { connection } from '../app/database/mysql'
import { UserModel } from './user.model'
```

- åˆ›å»º `user.Contorller.ts` å­˜æ”¾è·¯ç”±çš„æ§åˆ¶å™¨
  
  - å¯¼å…¥ express ä¸­çš„å¯¹åº”ç±»å‹
  
  - å¯¼å…¥å®šä¹‰çš„`UserModel` 
  
  - å¯¼å…¥å®šä¹‰çš„æ‰€æœ‰æœåŠ¡

```js
/*
user/user.contotller.ts
*/

import {Request , Response , NextFunction} from 'express'
import { UserModel } from './user.model'
import * as userService from "./user.service"
```

- åˆ›å»º`user.middleware.ts `æ–‡ä»¶å­˜æ”¾æ‰€æœ‰ç”¨æˆ·ç›¸å…³çš„ä¸­é—´ä»¶
  
  - - å¯¼å…¥ express ä¸­çš„å¯¹åº”ç±»å‹
    
    - å¯¼å…¥å®šä¹‰çš„æ‰€æœ‰æœåŠ¡

```js
/*
user/user.middleware.ts
*/

import {Request , Response , NextFunction} from 'express'
import * as userService from "./user.service"
```

- å®šä¹‰`user.router.ts` å­˜å‚¨æ‰€æœ‰ user ç›¸å…³çš„æ¥å£
  
  - å¯¼å…¥express
  
  - å¯¼å…¥æ‰€æœ‰çš„ contorller
  
  - å®šä¹‰ä¸€ä¸ªæ¥å£å¹¶å°†å…¶å¯¼å‡º , åœ¨ `app/index.ts`ä¸­è°ƒç”¨æ¥å£

```js
/*
user/user.router.ts
*/
import express from 'express'
import * as userContorller from './user.contorller'

/**
 * å®šä¹‰è·¯ç”±
 */
const router = express.Router();


/**
 * å¯¼å‡ºè·¯ç”±
 */
export default router;
```

```js
/*
app/index.ts
*/
import userRouter from '../user/user.router'
app.use(postRouter,userRouter)
```



## 2. ç”¨æˆ·æ³¨å†Œæ¥å£

```js
/*
user/user.service.ts
*/

/**
 * æ’å…¥ä¸€ä¸ªæ–°ç”¨æˆ·
 * @param user æ’å…¥çš„ç”¨æˆ·å…·ä½“å­—æ®µ
 * @returns 
 */
export const createUser = async (user: UserModel) => {
    // å‡†å¤‡æŸ¥è¯¢
    const statement = `
        INSERT INTO user
        SET ?
    `

    // åˆ›å»ºæ•°æ®å¹¶è·å¾—ç»“æœ
    const data = await connection.promise().query(statement,user)

    // è¿”å›æ•°æ®
    return data;
}
```

```js
/*
user/user.contorller.ts
*/



/**
 * æ·»åŠ ç”¨æˆ·æ•°æ®çš„æ§åˆ¶å™¨
 * @param req 
 * @param res 
 * @param next 
 */
export const store = async (
    req : Request,
    res : Response,
    next : NextFunction
) => {
    // å‡†å¤‡æ•°æ®
    const { name , password} = req.body;
    // åˆ›å»ºç”¨æˆ·
    try {
        const data = await userService.createUser({name,password});
        res.status(201).send(data);
    } catch (error) {
        next(error)
    }
}
```

```js
/*
user/user.router.ts
*/


/**
 * æ·»åŠ ç”¨æˆ·æ•°æ®çš„æ¥å£
 */
router.post("/users" , userContorller.store)

```



## 3. éªŒè¯ç”¨æˆ·æ•°æ®

- åœ¨åˆ›å»ºä¹‹å‰éœ€è¦éªŒè¯ä¸€ä¸‹å®¢æˆ·ç«¯è¿”å›çš„æ•°æ®å®Œæ•´æ€§

- é€šè¿‡ä¸­é—´ä»¶æ¥éªŒè¯

```js
/*
user/user.middleware.ts
*/


export const validateUserData = async (
    req : Request,
    res : Response,
    next : NextFunction
) => {
    console.log("ğŸ‘®ğŸ» éªŒè¯ç”¨æˆ·æ•°æ®å®Œæ•´æ€§");
    
    const {name , password} = req.body;

    // éªŒè¯æ•°æ®å®Œæ•´æ€§
    if (!name) next(new Error("NAME_IS_REQUIRED"));
    if (!password) next(new Error("PASSEORD_IS_REQUIRED"));

    // æ²¡é—®é¢˜äº¤ç»™æ§åˆ¶å™¨åˆ›å»º
    next()
}
```

```js
/*
user/user.router.ts
*/

/**
 * æ·»åŠ æ•°æ®çš„æ¥å£
 */
router.post("/users" ,validateUserData, userContorller.store)
```

> æ­¤æ—¶å› ä¸ºé”™è¯¯å¤„ç†å™¨æ˜¯é»˜è®¤çš„ , åªèŒƒæ¹–å›ºå®šä¿¡æ¯ , å¯ä»¥ä¿®æ”¹é”™è¯¯å¤„ç†å™¨å°†æ•°æ®éªŒè¯çš„ç¡®å®è¿”å›ç»™å®¢æˆ·ç«¯



## 4. ä¼˜åŒ–é»˜è®¤çš„é”™è¯¯å¤„ç†å™¨

- åœ¨é”™è¯¯å¤„ç†å™¨çš„`switch` ä¸­æ·»åŠ å¯¹äº`NAME/PASSWORD_IS_REQUIRED`çš„`case` 

```js
 /*
 app/app.middleware.ts
 */
 
 // åˆ¤æ–­é”™è¯¯ä¿¡æ¯
    switch (error.message) {
        case "NAME_IS_REQUIRED":
            statuCode=  400; // bad request
            message = "ç¼ºå°‘ç”¨æˆ·å"
            break;
        case "PASSWORD_IS_REQUIRED":
            statuCode=  400; // bad request
            message = "ç¼ºå°‘ç”¨æˆ·å¯†ç "
            break;
        default:
            statuCode = 500;
            message = "é»˜è®¤é”™è¯¯å¤„ç†"
            break;
    }
```



## 5. æ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾

- ç”¨æˆ·åœ¨æ³¨å†Œçš„æ—¶å€™éœ€è¦æŸ¥æ‰¾ä¸€ä¸‹æ˜¯å¦å·²ç»åœ¨æ•°æ®åº“ä¸­å­˜åœ¨

- ç™»å½•çš„æ—¶å€™ä¹Ÿéœ€è¦æŸ¥è¯¢æ•°æ®åº“

- éœ€è¦å®šä¹‰ä¸€ä¸ªæ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾ç”¨æˆ·çš„æ–¹å¼

```js
/**
 * æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢æ•°æ®åº“ä¸­çš„æ•°æ®
 * @param name è¦æŸ¥è¯¢çš„ç”¨æˆ·å
 * @returns 
 */
export const getUserByName = async (name : string) => {
    // å‡†å¤‡æŸ¥è¯¢
    const statement = `
        SELECT 
            id,
            name,
        FROM user
        WHERE name = ?
    `

     // è·å–ç»“æœ
    const [data] = await connection.promise().query(statement , name)

    // è¿”å›ç»“æœ
    return data[0]; // å› ä¸º name å­—æ®µåœ¨æ•°æ®åº“ä¸­å·²ç»è®¾ç½®ä¸ºå”¯ä¸€çš„äº† 
Â Â Â Â // ç»“æœå°±å­˜åœ¨äºç¬¬ä¸€é¡¹ä¸­ , ä¸å­˜åœ¨ä¼šè¿”å› undefiend
}
```



## 6. æ£€æŸ¥æ˜¯å¦æ˜¯æ–°ç”¨æˆ·

- åœ¨æ³¨å†Œçš„æ—¶å€™å¯ä»¥åˆ©ç”¨åˆšæ‰å®šä¹‰çš„æ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾çš„æœåŠ¡æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨

```js
/*
user/user.middleware.ts
*/

export const validateUserData = async (
    req : Request,
    res : Response,
    next : NextFunction
) => {
    console.log("ğŸ‘®ğŸ» éªŒè¯ç”¨æˆ·æ•°æ®å®Œæ•´æ€§");
    
    const {name , password} = req.body;

    // éªŒè¯æ•°æ®å®Œæ•´æ€§
    // éªŒè¯æ˜¯å¦å·²å­˜åœ¨
    const user = userService.getUserByName(name);
    // å¦‚æœå·²ç»å­˜åœ¨
    if (name) return next(new Error("USERNAME_ALREDY_EXIST"))

    // æ²¡é—®é¢˜äº¤ç»™æ§åˆ¶å™¨åˆ›å»º
    next()
}
```

```js
/*
app/app.middleware.ts
*/

// defaultErrorHendler æ–°å¢ case
    case "USERNAME_ALREDY_EXIST":
            statuCode=  409 // å†²çª
            message = "ç”¨æˆ·å·²å­˜åœ¨"
            break;
```

## 7. å¯†ç å­˜å‚¨

- ä¸€èˆ¬ä¸ä¼šç›´æ¥å­˜å‚¨å¯†ç 

- ä¼šé€šè¯´`Bcrypt` å°†å¯†ç  Hash åŒ– , è¿™æ ·ä¿å­˜çš„å¯†ç å°±ä¸æ˜¯åŸå¯†ç äº†

- ä¹Ÿå¯ä»¥åœ¨ å¯†ç ä¸ŠåŠ ä¸Š`salt` (ä¸€æ®µéšæœºå­—ç¬¦) å¯†ç å°±æ›´éš¾çŒœæµ‹äº†

- å…ˆå®‰è£…`bcrypt` 
  
  - æä¾› Hash æ•°æ® , æ¯”å¯¹ Hash æ•°æ®çš„æ–¹æ³•
  
  - å®‰è£…è¿‡ç¨‹ä¸­éœ€è¦ç¼–è¯‘ , MAC ä¸­éœ€è¦æœ‰ Xcode

```zsh
npm install bcrypt @types/bcrypt --save-dev
```

- ä½¿ç”¨`bcrypt` ä¸­çš„`hash()` hash å¯†ç  
  
  - ç¬¬ä¸€ä¸ªå‚æ•°å®šä¹‰ è¦ hash çš„æ•°å€¼
  
  - ç¬¬äºŒä¸ªå‚æ•°å®šä¹‰å¼ºåº¦
  
  - ä¼šè¿”å›hash çš„ç»“æœ

```js
/**
 * hash åŒ–å¯†ç 
 * @param req 
 * @param res 
 * @param next 
 */
export const hashPassword = async (
    req : Request,
    res : Response,
    next : NextFunction
) => {
    // è·å–å¯†ç 
    const {password} = req.body;
    // æ›¿æ¢ä¸º hash åçš„å¯†ç 
    req.body.password = await bcrypt.hash(password , 10);// æ³¨æ„ await
    // ç»§ç»­æ‰§è¡Œæ§åˆ¶å™¨
    next()
}
```

- ä½œä¸ºä¸­é—´ä»¶æ”¾åœ¨`valiDateUserData` åé¢ , è¿™æ ·å¯ä»¥ä¿è¯åœ¨æœ‰ password çš„æƒ…å†µä¸‹è¿›è¡Œhash

```js
/*user/user.router.ts*/

/**
 * æ·»åŠ æ•°æ®çš„æ¥å£
 */
router.post("/users" ,validateUserData, hashPassword ,userContorller.store)

```


