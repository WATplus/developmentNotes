# å¼€å‘è®°å½•-ç”¨æˆ·ç™»å½•

[toc]

## 1. èº«ä»½éªŒè¯æ¨¡å—

- åˆ›å»º`auth` ç›®å½• å­˜æ”¾ç”¨æˆ·éªŒè¯çš„å†…å®¹

- `auth/auth.revice.ts` å­˜æ”¾æœåŠ¡

- `auth/auth.contorller.ts` å­˜æ”¾æ§åˆ¶å™¨

- `auth/auth.middleware.ts` å­˜æ”¾ä¸­é—´ä»¶

- `auth/auth.router.ts` å­˜æ”¾æ¥å£ä»£ç å¹¶å¯¼å‡ºæ¥å£
  
  - åœ¨`app/index.ts` ä¸­`use` æ¥å£

## 2. å®šä¹‰ç”¨æˆ·ç™»å½•æ¥å£çš„æ§åˆ¶å™¨

- åˆ›å»ºæ§åˆ¶å™¨

```js
/*auth/auth,contorller.ts*/

export const login = async (
    req : Request,
    res : Response,
    next : NextFunction
) => {
    // å‡†å¤‡æ•°æ®
    const {name , password} = req.body;

    // è¿”å›ç™»å½•ç»“æœ
    res.send({"message":`ğŸ‘ğŸ» æ¬¢è¿å›æ¥ ${name}`})
}
```

- åº”ç”¨åˆ°`login`åœ°å€ä¸Šçš„`post` è¯·æ±‚ä¸­

```js
/*auth/auth,router.ts*/
router.post("/login" , authContorller.login)
```

## 3. éªŒè¯ç™»å½•æ•°æ®å®Œæ•´æ€§

- åŠŸèƒ½ä¸`user/user.middleware.ts` ä¸­çš„`validateUserData` å·®ä¸å¤š , å¯ä»¥ç›´æ¥å¤åˆ¶ä¿®æ”¹

```js
/*auth/auth,middleware.ts*/
/**
 * éªŒè¯ç”¨æˆ·çš„å®Œæ•´æ€§
 * @param req 
 * @param res 
 * @param next 
 */
export const validateUserData = async (
    req : Request,
    res : Response,
    next : NextFunction
) => {
    console.log("ğŸ‘®ğŸ» éªŒè¯ç™»å½•æ•°æ®å®Œæ•´æ€§");
    
    // ...

    // å¦‚æœä¸å­˜åœ¨
    if (!user) return next(new Error("USERNAME_DOES_NOT_EXIST"))

    // æ²¡é—®é¢˜äº¤ç»™æ§åˆ¶å™¨åˆ›å»º
    next()
}
```

```js
/*auth/auth,router.ts*/
/**
 * ç™»å½•æ¥å£
 */
router.post("/login" , validateLoginData , authContorller.login)
```

- ç¼ºå°‘ name å’Œ passwordçš„é”™è¯¯å¤„ç†åœ¨å†™ user æ¥å£çš„æ—¶å€™å°±å·²ç»å®šä¹‰äº†

- è¿˜éœ€è¦å®šä¹‰å¯¹ç”¨æˆ·ä¸å­˜åœ¨çš„é”™è¯¯å¤„ç†

```js
/*app/app,middleware.ts*/

// ...
    case "USERNAME_DOES_NOT_EXIST":
            statuCode=  400 // bad request
            message = "ç”¨æˆ·ä¸å­˜åœ¨"
            break;
// ...
```

## 4.  é‡æ„æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢

- `user/user.service.ts` ä¸­çš„`getUserByName` éœ€è¦è¿›è¡Œé‡æ„

- è®©å®ƒæ›´åŠ çµæ´» , é€šè¿‡`options` å‚æ•°æ§åˆ¶æ˜¯å¦æŸ¥è¯¢å¯†ç 

```js
/*user/app,service.ts*/

interface GetUserOptions { // å®šä¹‰ä¸€ä¸ªæ¥å£
    password? : boolean;
}

export const getUserByName = async (
    name : string ,
    options:GetUserOptions = {}// é»˜è®¤ä¸ºç©º
) => {
    // å‡†å¤‡é€‰é¡¹
    const {password} = options;
    // å‡†å¤‡æŸ¥è¯¢
    const statement = `
    SELECT 
        id,
        name
        ${options ?  ', password' : ''}
    FROM user
    WHERE name = ?
    `
// ...
```

> `${options ? ', password' : ''}` ä¼šåœ¨ opations ä¸º true çš„æ—¶å€™æŸ¥è¯¢ password , åœ¨ä¸º false çš„æ—¶å€™ä¸æŸ¥è¯¢

### 4.1 interface

- å­—é¢æ„ä¹‰æ˜¯æ¥å£
- ç”¨äºå®šä¹‰ä¸€ç§æ•°æ®ç±»å‹
- æ˜¯ TypeScript ä¸­ç‰¹æœ‰ , åªåœ¨åº”ç”¨å¼€å‘è¿‡ç¨‹ä¸­æœ‰ç”¨ , ç¼–è¯‘æ—¶ä¼šè¢«æ›¿æ¢

```js
interface User { // å®šä¹‰ User interface
    id : number; // id å±æ€§ä¸ºæ•°å­—
    name : string; // name å±æ€§ä¸ºå­—ç¬¦ä¸²
}
```

## 5. åˆ©ç”¨é‡æ„çš„ç”¨æˆ·æŸ¥è¯¢éªŒè¯å¯†ç 

- æŸ¥è¯¢çš„æ—¶å€™é€šè¿‡æ·»åŠ ç¬¬äºŒä¸ªå‚æ•°`{password:true}`æŸ¥è¯¢åˆ°å¯†ç 

- ä½¿ç”¨`bcrypt.compare()` éªŒè¯å¯†ç æ˜¯å¦æ­£ç¡®
  
  - ä¼ é€’ä¸¤ä¸ªå‚æ•° , ä¸‹é¢çš„`password` æ˜¯ä»`req.body`ä¸­ç»“æ„å‡ºæ¥çš„å®¢æˆ·ç«¯è¯·æ±‚çš„ç™»å½•å¯†ç 
  
  - `user.password` æ˜¯æŸ¥è¯¢ç»“æœä¸­çš„æ•°æ®åº“ä¸­å­˜å‚¨çš„ `password` å­—æ®µ

```js
/*auth/auth.middleware.ts*/
/**
 * éªŒè¯ç”¨æˆ·çš„å®Œæ•´æ€§
 * @param req 
 * @param res 
 * @param next 
 */
export const validateLoginData = async (
    req : Request,
    res : Response,
    next : NextFunction
) => {
    console.log("ğŸ‘®ğŸ» éªŒè¯ç™»å½•æ•°æ®å®Œæ•´æ€§");
    
    const {name , password} = req.body;

    if (!name) return next(new Error("NAME_IS_REQUIRED"));
    if (!password) return next(new Error("PASSWORD_IS_REQUIRED"));

    // é”Œå±‚å‚æ•° , æŸ¥è¯¢ç”¨æˆ·çš„åŒæ—¶æŸ¥è¯¢å¯†ç 
    const user = await userService.getUserByName(name , {password:true});
    if (!user) return next(new Error("USERNAME_DOES_NOT_EXIST"))

    // éªŒè¯å¯†ç 
    const matched = await bcrypt.compare(password , user.password)
    if (!matched) return next(new Error("PASSWORD_DOES_MATCHED"))

    next()
}
```

- åœ¨ defaultErrorHendler ä¸­æ·»åŠ å¯†ç é”™è¯¯ä¿¡æ¯çš„ case

```js
/*app/app.middleware.ts*/
// ...
        case "PASSWORD_DOES_MATCHEDT":
            statuCode=  400 // bad request
            message = "å¯†ç é”™è¯¯"
            break;
// ...
```
